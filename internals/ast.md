# The BCC2 AST

The internal AST is the first intermediate representation generated by the compiler and is built by the parser.  The parser emits an spotty AST with symbols unresolved and with expressions unannotated by types.  

After parsing, a series of semantic analysis passes are made to fill in info on the AST and to find any semantic errors in the source code.  After these passes, the AST should be 100% valid (this is assumed during intermediate code generation).


The BCC2 AST is made up a list of functions.

## AST Definition

### Function 

A function represents a single function in the source code with all the information needed to reconstruct the source.

| member_name | description |
| ------------|-------------|
| name   | FatPtr to source |  
| params | Vector of Param  |
| ret    | Type*            |
| stmts  | Vector of Stmt   | 


### Stmt 

Most of Beans is an expression language, but there are a handful of constructs that are expressed as statements rather than expressions.

Statements are represented as a variant enum with a discriminator called "t" and a SourcePosition representing the start and end in the source code.

#### Kinds 

* STMT_LET - Introduces a name (optionally a value) to the enviroment 

| member_name | description                         |
|-------------------------------------|-------------|
| name  | SourcePosition of new binding name        |
| type  | Type* (null if inferred, filled in later) |
| value | Expr* (null if not initialized)           |
| var   | ScopeEntry* to symbol table               |


* STMT_RETURN - Returns from the current function, optionally with a value

| member_name | description                   |
|-------------------------------------|-------|
| return | Expr* (null if nothing is returned |

* STMT_EXPR - A single expression terminated with a ';'


| member_name | description                   |
|-------------------------------------|-------|
| expr | Expr* |

### Expr

Expressions are represented as a variant enum with a discriminator called "t" and a SourcePosition representing the start and end in the source code.

#### Kinds

* EXPR_INT - Single integer literal

(uses SourcePosition)

* EXPR_VAR - Reference to an existing variable 

(uses SourcePosition)

* EXPR_BINOP - Binary operation  with two expressions on the left and right

| member_name | description                   |
|-------------------------------------|-------|
| left  | Expr* |
| right | Expr* |
| op    | int   |


### Type

Type is also represented as a variant enum with a discriminator called "t". Currently there are only builtin types, so there is no need for conglomerate types.

All builtin types are statically allocated, and can be found in type.h.

## AST Passes

### Symbol Resolution

File: sem_names.c

The first pass needed resolves all symbols by first inserting all toplevels into the global symbol table, and then iterating over functions and their local blocks, inserting local variables into the symbol table and then connecting variable references to those symbol table entries.

### Type Resolution

File: sem_types.c

This pass iterates through every statement and expression in the AST and gives each expression a type, and ensure that assignments and returns are sound type wise.
